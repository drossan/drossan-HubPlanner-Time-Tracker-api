package main

import (
	"encoding/json"
	"log"
	"os"

	"hubplanner-proxy-api/adapters/routes/echo"
	"hubplanner-proxy-api/config"
	"hubplanner-proxy-api/infrastructure/router"
)

func main() {
	/*******************************************************************************************************************
	LOAD DEFAULT CONFIGURATION
	*******************************************************************************************************************/
	cfg := config.LoadConfig()

	/*******************************************************************************************************************
	INIT ROUTER
	*******************************************************************************************************************/
	e, groupAPIRestricted, groupAPIAccessible, _ := router.NewEchoRouter(cfg.Server.JWTSecret)

	/*******************************************************************************************************************
	LOAD ROUTES
	*******************************************************************************************************************/
	echo.LoadRoutes(groupAPIRestricted, groupAPIAccessible)

	/*******************************************************************************************************************
	MAP ROUTES
	*******************************************************************************************************************/
	data, err := json.MarshalIndent(e.Routes(), "", "  ")
	if err != nil {
		panic(err)
	}
	err = os.WriteFile("routes.json", data, 0644)
	if err != nil {
		log.Printf("Failed to created routes.json: %v", err)
	}

	/*******************************************************************************************************************
	LAUNCH SERVER
	*******************************************************************************************************************/
	log.Fatal(e.Start(cfg.Server.Address))

}
